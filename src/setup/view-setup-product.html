<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../view-app.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">
<link rel="import" href="redux-mixin.html">

<dom-module id="view-setup-product">
    <template>
        <style include="shared-styles app-grid-style flat-button">
             :host {
                margin: 10px;
                display: block;
                --app-grid-columns: 1;
                --app-grid-item-height: 50%;
            }

            .btn {
                margin: 20px 10px 0 0;
                width: 250px;
            }

            .add-btn {
                margin: 10px 0 10px;
                width: 250px;
            }


            .btn-block {
                width: 100%;
            }

            .item {
                border-bottom: 1px solid #eee;
                padding: 10px;
            }

            .product-image {
                height: auto;
                width: 100px;
            }

            .image-cell {
                height: 100px;
                width: 100px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .details {
                padding: 10px;
                display: flex;
                justify-content: space-around;
                align-items: center;
            }

            .part-list {
                height: 200px;
            }

            .part {
                margin: 10px;
                padding: 20px;
                border: 1px solid rgba(0, 0, 0, .10);
                border-radius: 2px;
            }

            .part p {
                margin: 10px 0;
            }

            .part h1 {
                text-align: center;
            }

            .part-info-group {
                margin-bottom: auto;
            }

            .flex-container {
                padding: 10px;
                margin: 0;
                list-style: none;
                -ms-box-orient: horizontal;
                display: -webkit-box;
                display: -moz-box;
                display: -ms-flexbox;
                display: -moz-flex;
                display: -webkit-flex;
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }

            .flex-item {
                width: auto;
                flex: 1;
            }

            .part-block {
                margin: 20px 0 0 0;
            }

            vaadin-grid#productTable {
                height: 700px;

                --vaadin-grid-body-cell: {
                    height: 200px;
                }
            }
        </style>
        <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
        <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
        <firebase-query app-name="smart-mes" id="productQuery" path="/data/[[k.key]]/factoryData/product" order-by-child="name" data="{{productData}}"></firebase-query>
        <firebase-document app-name="smart-mes" id="editProductQuery" path="/data/[[k.key]]/factoryData/product/[[editKey]]" data="{{editProductData}}"></firebase-document>
        <firebase-query app-name="smart-mes" id="processQuery" path="/data/[[k.key]]/factoryData/station" order-by-child="st_number"
            data="{{processData}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="inventoryQuery" path="/data/[[k.key]]/factoryData/inventory" order-by-child="name"
            data="{{inventoryData}}"></firebase-query>
        <!-- <firebase-storage-ref app-name="smart-mes" path="data/[[k.key]]/product" metadata="{{metadata}}" storage-uri="gs://smart-mes.appspot.com/data/[[k.key]]/product"
            download-url="{{downloadUrl}}">
        </firebase-storage-ref> -->
        <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
        <app-indexeddb-mirror session="[[user.uid]]" key="product-data" data="{{productData}}" persisted-data="{{persistedProductData}}"></app-indexeddb-mirror>
        <ul class="app-grid">
            <li>
                <!-- Add product card!-->
                <div class="card" hidden="[[showAddProduct]]">
                    <h1 class="title">{{localize('add-product')}}</h1>
                    <paper-input label="{{localize('product-name')}}*" id="productName" type="text" required always-float-label></paper-input>
                    <paper-input label="{{localize('sku-code')}}*" id="productSKU" type="text" allowed-pattern="^(0|[1-9]\d*)$" required always-float-label></paper-input>
                    <paper-input label="{{localize('cost')}}" id="productCost" type="number" maxlength="9" allowed-pattern="^(0|[1-9]\d*)(\.\d+)?$"
                        error-message="number only" min="0" max="99999" step="0.01" auto-validate always-float-label></paper-input>
                    <vaadin-combo-box label="{{localize('raw-materials-required')}}" id="inventoryCode" items="[[inventoryData]]" item-value-path="code"
                        item-label-path="name" loading="[[!inventoryData]]" always-float-label>
                        <template>
                            <paper-item>
                                <paper-item-body>
                                    <div>[[item.name]]</div>
                                </paper-item-body>
                            </paper-item>
                        </template>
                    </vaadin-combo-box>
                    <paper-input label="Raw material quantity" id="inventoryQuantity" type="number" allowed-pattern="^(0|[1-9]\d*)$" required
                        always-float-label></paper-input>

                    <flat-button on-tap="openBrowseImageFile" class="btn">
                        <button>{{localize('browse-image')}}</button>
                        <input type="file" accept="image/*" name="file" id="uploadImageFile" on-change="_verifyUploadFile" class="inputfile" />
                    </flat-button>

                    <flat-button class="btn" on-tap="openAddPartDialog">
                        <button>{{localize('add-part')}}</button>
                    </flat-button>

                    <flat-button class="btn" on-tap="clearPartFromProduct">
                        <button>{{localize('clear')}}</button>
                    </flat-button>

                    <div class="frame part-block">
                        <ul class="flex-container wrap">
                            <template is="dom-repeat" items="[[productPart]]" as="part">
                                <li class="flex-item">
                                    <div class="part">
                                        <div class="part-info-group">
                                            <h2 class="title">[[part.name]]</h2>
                                            <p>{{localize('sku-code')}}: [[part.sku]]</p>
                                            <div class="frame">
                                                <div class="part-list">
                                                    <iron-list items="[[getPartBundle(part.process, part.cycle, part.setup)]]" as="item">
                                                        <template>
                                                            <div tabindex$="[[tabIndex]]" class="item">
                                                                <p>
                                                                    <strong>{{localize('process-number')}} [[item.process]]</strong>
                                                                </p>
                                                                <p>{{localize('cycle-time')}} [[item.cycle]] {{localize('mins')}}.</p>
                                                                <p>{{localize('setup-time')}} [[item.setup]] {{localize('mins')}}.</p>
                                                            </div>
                                                        </template>
                                                    </iron-list>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="center">
                                            <flat-button class="btn" on-tap="openEditPartDialog" part="[[part]]">
                                                <button>{{localize('edit')}}</button>
                                            </flat-button>
                                            <flat-button class="thunderbird btn" on-tap="removePartFromProduct">
                                                <button>{{localize('remove')}}</button>
                                            </flat-button>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div class="center">
                        <flat-button class="btn" on-tap="openProductList">
                            <button>{{localize('dismiss')}}</button>
                        </flat-button>
                        <flat-button class="btn shamrock" on-tap="addProduct">
                            <button>{{localize('add')}}</button>
                        </flat-button>
                    </div>
                </div>
            </li>
            <li>
                <!-- Edit product card !-->
                <div class="card" hidden="[[showEditProduct]]">
                    <h1 class="title">{{localize('edit-product')}}</h1>
                    <paper-input label="{{localize('product-name')}}*" id="editProductName" type="text" value="{{editProductData.name}}" required
                        always-float-label></paper-input>
                    <paper-input label="{{localize('sku-code')}}*" id="productPartSKU" type="text" allowed-pattern="^(0|[1-9]\d*)$" value="{{editProductData.sku}}"
                        required always-float-label></paper-input>
                    <paper-input label="{{localize('cost')}}" id="productCost" type="number" maxlength="9" value="{{editProductData.cost}}" allowed-pattern="^(0|[1-9]\d*)(\.\d+)?$"
                        error-message="number only" min="0" max="99999" step="0.01" auto-validate always-float-label></paper-input>
                    <paper-input label="Inventory Code" id="inventoryCode" type="text" value="{{editProductData.inventory_code}}" required always-float-label></paper-input>
                    <paper-input label="Inventory Require" id="inventoryQuantity" type="number" value="{{editProductData.inventory_use}}" allowed-pattern="^(0|[1-9]\d*)$"
                        required always-float-label></paper-input>

                    <paper-progress value="0" min="0" max="100" class="upload-bar" id="uploadProgress"></paper-progress>
                    <flat-button on-tap="openBrowseImageFile" class="btn">
                        <button>{{localize('browse-image')}}</button>
                        <input type="file" accept="image/*" name="file" id="uploadImageFile" on-change="_verifyUploadFile" class="inputfile" />
                    </flat-button>

                    <flat-button class="btn" on-tap="openAddPartDialog">
                        <button>{{localize('add-part')}}</button>
                    </flat-button>

                    <flat-button class="btn" on-tap="clearPartFromProduct">
                        <button>{{localize('clear')}}</button>
                    </flat-button>

                    <div class="frame part-block">
                        <ul class="flex-container wrap">
                            <template is="dom-repeat" items="[[editProductData.part]]" as="part">
                                <li class="flex-item">
                                    <div class="part">
                                        <div class="part-info-group">
                                            <h2 class="title">[[part.name]]</h2>
                                            <p>{{localize('sku-code')}}: [[part.sku]]</p>
                                            <div class="frame">
                                                <div class="part-list">
                                                    <iron-list items="[[getPartBundle(part.process, part.cycle, part.setup)]]" as="item">
                                                        <template>
                                                            <div tabindex$="[[tabIndex]]" class="item">
                                                                <p>
                                                                    <strong>{{localize('process-number')}} [[item.process]]</strong>
                                                                </p>
                                                                <p>{{localize('cycle-time')}} [[item.cycle]] {{localize('mins')}}.</p>
                                                                <p>{{localize('setup-time')}} [[item.setup]] {{localize('mins')}}.</p>
                                                            </div>
                                                        </template>
                                                    </iron-list>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="center">
                                            <flat-button class="btn" on-tap="openEditPartDialog" part="[[part]]">
                                                <button>{{localize('edit')}}</button>
                                            </flat-button>
                                            <flat-button class="thunderbird btn" on-tap="removePartFromProduct">
                                                <button>{{localize('remove')}}</button>
                                            </flat-button>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div class="center">
                        <flat-button class="btn" on-tap="openProductList">
                            <button>{{localize('dismiss')}}</button>
                        </flat-button>
                        <flat-button class="btn shamrock" on-tap="saveProduct">
                            <button>{{localize('save')}}</button>
                        </flat-button>
                    </div>
                </div>
                <!-- Show product management !-->
                <div class="card" hidden="[[showListProduct]]">
                    <h1 class="title">{{localize('product-management')}}</h1>
                    <vaadin-grid id="productTable" aria-label="Product Management" active-item="{{activeItem}}" selected-items="{{selectedItem}}"
                        items="[[persistedProductData]]" size="10">
                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell center">{{localize('image')}}</div>
                            </template>
                            <template>
                                <div class="cell image-cell center">
                                    <img class="product-image" src="[[item.image]]" alt="No Image">
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">{{localize('name')}}</div>
                            </template>
                            <template>
                                <div class="cell">[[item.name]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">{{localize('sku-code')}}</div>
                            </template>
                            <template>
                                <div class="cell">[[item.sku]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">{{localize('part')}}</div>
                            </template>
                            <template>
                                <div class="cell">
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[productPart.name]]</p>
                                    </template>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">{{localize('sku-code')}}</div>
                            </template>
                            <template>
                                <div class="cell">
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[productPart.sku]]</p>
                                    </template>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Inventory Code</div>
                            </template>
                            <template>
                                <div class="cell">
                                    <p>[[item.inventory_code]]</p>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Inventory Require</div>
                            </template>
                            <template>
                                <div class="cell">
                                    <p>[[item.inventory_use]]</p>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">{{localize('cost')}}</div>
                            </template>
                            <template>
                                <div class="cell">[[item.cost]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="0">
                            <template class="header">
                                <div class="cell">{{localize('detail')}}</div>
                            </template>
                            <template>
                                <paper-checkbox aria-label$="Show Details for [[item.name]]" checked="{{detailsOpened}}"></paper-checkbox>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="0">
                            <template class="header">
                                <div class="cell last">{{localize('edit')}}</div>
                            </template>
                            <template>
                                <div class="cell last">
                                    <paper-icon-button on-tap="openEditProductCard" product="[[item]]" icon="vaadin:pencil" title="Edit"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="0">
                            <template class="header">
                                <div class="cell last">{{localize('delete')}}</div>
                            </template>
                            <template>
                                <div class="cell last">
                                    <paper-icon-button on-tap="removeProduct" product="[[item]]" icon="vaadin:trash" title="Delete"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <!-- Row detail -->
                        <template class="row-details">
                            <div class="details">
                                <div class="flex-item">
                                    <h3>{{localize('part-name')}}</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[productPart.name]]</p>
                                    </template>
                                </div>
                                <div class="flex-item">
                                    <h3>{{localize('process-sequence')}}</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[getProductProcessSequence(productPart.process)]]</p>
                                    </template>
                                </div>
                                <div class="flex-item">
                                    <h3>{{localize('process-number')}}</h3>
                                    <template is="dom-repeat" items="[[item.process]]" as="productProcess">
                                        <p>[[getProcessNumber(productProcess.number)]]</p>
                                    </template>
                                </div>
                                <div class="flex-item">
                                    <h3>Part Dependency</h3>
                                    <template is="dom-repeat" items="[[item.process]]" as="productProcess">
                                        <p>[[productProcess.required]]</p>
                                    </template>
                                </div>
                            </div>
                            <div class="details">
                                <div class="flex-item">
                                    <h3>{{localize('setup-time')}} ({{localize('mins')}})</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[getProductProcessSequence(productPart.setup)]]</p>
                                    </template>
                                </div>
                                <div class="flex-item">
                                    <h3>Total Setup time ({{localize('mins')}})</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[getSumSetupTime(productPart.setup)]]</p>
                                    </template>
                                </div>

                                <div class="flex-item">
                                    <h3>{{localize('cycle-time')}} ({{localize('mins')}})</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[getProductProcessSequence(productPart.cycle)]]</p>
                                    </template>
                                </div>
                                <div class="flex-item">
                                    <h3>Total Cycle time ({{localize('mins')}})</h3>
                                    <template is="dom-repeat" items="[[item.part]]" as="productPart">
                                        <p>[[getSumCycleTime(productPart.cycle)]]</p>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </vaadin-grid>
                    <div class="center">
                        <flat-button class="btn" on-tap="openAddProductCard">
                            <button>{{localize('add-product')}}</button>
                        </flat-button>
                    </div>
                </div>
            </li>
        </ul>

        <!-- ADD Part dialog !-->
        <vaadin-dialog id="addPartDialog" class="dialog" no-close-on-outside-click>
            <template id="addPartContent">
                <custom-style>
                    <style is="custom-style" include="view-setup-product">
                         :host {
                            height: 100vh;
                            margin: 0 auto;
                            --app-primary-color: #202020;
                            --paper-input-container-focus-color: var( --app-primary-color);
                            overflow: auto;
                        }

                        [part="content"] {
                            padding: 20px 30px;
                        }

                        .title {
                            margin: 10px 0 20px 0;
                        }

                        .btn {
                            width: 250px;
                        }

                        .block-group {
                            margin: 10px 0;
                        }

                        .delete-btn {
                            float: right;
                        }

                        .frame {
                            min-height: 250px;
                        }

                        .process-list {
                            height: 250px;
                        }

                        .grid-item {
                            border-bottom: 1px solid #eee;
                            padding: 10px;
                            height: 100px;
                        }

                        .grid-item:hover {
                            background-color: #eee;
                        }
                    </style>
                </custom-style>
                <h1 class="title center">{{localize('add')}} {{localize('product-part')}}</h1>
                <div class="block-group">
                    <paper-input label="{{localize('name')}}" id="partName" value="{{partName}}" type="text" always-float-label></paper-input>
                    <paper-input label="{{localize('sku-code')}}" id="partSKU" value="{{partSKU}}" type="text" always-float-label></paper-input>
                </div>
                <div class="block-group">
                    <!-- Add Process -->
                    <h3>Process of Part</h3>
                    <p>([[partProcess.length]] / [[maxProcess]])</p>
                    <vaadin-combo-box label="{{localize('process-number')}}" id="processNumber" items="[[processData]]" name="Process selector"
                        item-label-path="st_number" item-value-path="st_number" value="{{selectedProcess}}" error-message="Invalid input"
                        loading="[[!processData]]" required always-float-label='true'>
                        <template>
                            <paper-item>
                                <paper-item-body three-line style="min-height: 0">
                                    <div style="text-transform: capitalize">{{localize('process-name')}}: [[item.st_name]]</div>
                                    <div secondary>{{localize('process-number')}}: [[item.st_number]]</div>
                                    <div secondary>[[item.st_machine.length]] {{localize('machine')}}</div>
                                </paper-item-body>
                            </paper-item>
                        </template>
                    </vaadin-combo-box>
                    <paper-input label="Process Cycle Time (mins)" id="processCycle" value="{{processCycle}}" type="number" maxlength="9" error-message="number only"
                        min="0" max="[[maxInput]]" step="0.01" auto-validate always-float-label></paper-input>
                    <paper-input label="Process Setup Time (mins)" id="processSetup" value="{{processSetup}}" type="number" maxlength="9" error-message="number only"
                        min="0" max="[[maxInput]]" step="0.01" auto-validate always-float-label></paper-input>

                    <flat-button class="add-btn" on-tap="addProcessToPart">
                        <button>Add Process</button>
                    </flat-button>
                </div>
                <div class="frame">
                    <div class="process-list">
                        <iron-list items="[[processBundle]]" as="item">
                            <template>
                                <div tabindex$="[[tabIndex]]" class="grid-item">
                                    <p>
                                        <strong>{{localize('process-number')}} [[item.process]]</strong>
                                    </p>
                                    <p>{{localize('cycle-time')}} [[item.cycle]] {{localize('mins')}}.</p>
                                    <p>{{localize('setup-time')}} [[item.setup]] {{localize('mins')}}.</p>
                                    <paper-icon-button class="delete-btn" on-tap="removeProcessFromPart" icon="vaadin:close-small" title="Delete"></paper-icon-button>
                                </div>
                            </template>
                        </iron-list>
                    </div>
                </div>
                <div class="center">
                    <paper-button class="btn" dialog-dismiss on-tap="closeAddPartDialog">
                        {{localize('dismiss')}}
                    </paper-button>
                    <paper-button class="btn" dialog-confirm autofocus on-tap="addPartToProduct">
                        {{localize('add-part')}}
                    </paper-button>
                </div>
            </template>
        </vaadin-dialog>

        <!-- Edit part dialog !-->
        <vaadin-dialog id="editPartDialog" class="dialog" no-close-on-outside-click>
            <template id="editPartContent">
                <custom-style>
                    <style is="custom-style" include="view-setup-product">
                         :host {
                            height: 100vh;
                            margin: 0 auto;
                            --app-primary-color: #202020;
                            --paper-input-container-focus-color: var( --app-primary-color);
                            overflow: auto;
                        }

                        iron-list {
                            overflow-y: hidden !important;
                        }

                        [part="content"] {
                            padding: 20px 30px;
                        }

                        .title {
                            margin: 10px 0 20px 0;
                        }

                        .btn {
                            width: 250px;
                        }

                        .block-group {
                            margin: 10px 0;
                        }

                        .delete-btn {
                            float: right;
                        }

                        .frame {
                            min-height: 250px;
                        }

                        .process-list {
                            height: 250px;
                        }

                        .grid-item {
                            border-bottom: 1px solid #eee;
                            padding: 10px;
                            height: 100px;
                        }

                        .grid-item:hover {
                            background-color: #eee;
                        }
                    </style>
                </custom-style>
                <h1 class="title center">{{localize('edit')}} {{localize('product-part')}}</h1>
                <div class="block-group">
                    <paper-input label="{{localize('name')}}" id="partName" value="{{partName}}" type="text" always-float-label></paper-input>
                    <paper-input label="{{localize('sku-code')}}" id="partSKU" value="{{partSKU}}" type="text" always-float-label></paper-input>
                </div>
                <div class="block-group">
                    <!-- Add Process -->
                    <h3>Process of Part</h3>
                    <p>([[partProcess.length]] / [[maxProcess]])</p>
                    <vaadin-combo-box label="{{localize('process-number')}}" id="processNumber" items="[[processData]]" name="Process selector"
                        item-label-path="st_number" item-value-path="st_number" value="{{selectedProcess}}" error-message="Invalid input"
                        loading="[[!processData]]" required always-float-label='true'>
                        <template>
                            <paper-item>
                                <paper-item-body three-line style="min-height: 0">
                                    <div style="text-transform: capitalize">{{localize('process-name')}}: [[item.st_name]]</div>
                                    <div secondary>{{localize('process-number')}}: [[item.st_number]]</div>
                                    <div secondary>[[item.st_machine.length]] {{localize('machine')}}</div>
                                </paper-item-body>
                            </paper-item>
                        </template>
                    </vaadin-combo-box>
                    <paper-input label="{{localize('cycle-time')}} ({{localize('mins')}})" id="processCycle" value="{{processCycle}}" type="number"
                        maxlength="9" error-message="number only" min="0" max="[[maxInput]]" step="0.01" auto-validate always-float-label></paper-input>
                    <paper-input label="{{localize('setup-time')}} ({{localize('mins')}})" id="processSetup" value="{{processSetup}}" type="number"
                        maxlength="9" error-message="number only" min="0" max="[[maxInput]]" step="0.01" auto-validate always-float-label></paper-input>

                    <flat-button class="add-btn" on-tap="addProcessToPart">
                        <button>Add Process</button>
                    </flat-button>
                </div>
                <div class="frame">
                    <div class="process-list">
                        <iron-list items="[[processBundle]]" as="item">
                            <template>
                                <div tabindex$="[[tabIndex]]" class="grid-item">
                                    <p>
                                        <strong>{{localize('process-number')}} [[item.process]]</strong>
                                    </p>
                                    <p>{{localize('cycle-time')}} [[item.cycle]] {{localize('mins')}}.</p>
                                    <p>{{localize('setup-time')}} [[item.setup]] {{localize('mins')}}.</p>
                                    <paper-icon-button class="delete-btn" on-tap="removeProcessFromPart" icon="vaadin:close-small" title="Delete"></paper-icon-button>
                                </div>
                            </template>
                        </iron-list>
                    </div>
                </div>
                <div class="center">
                    <paper-button class="btn" dialog-dismiss on-tap="closeEditPartDialog">
                        {{localize('dismiss')}}
                    </paper-button>
                    <paper-button class="btn" dialog-confirm autofocus on-tap="addPartToProduct">
                        {{localize('add-part')}}
                    </paper-button>
                </div>
            </template>
        </vaadin-dialog>

        <paper-toast id="toastAlert" always-on-top horizontal-align="right" text="{{toastText}}"></paper-toast>
    </template>
    <script>
        /**
         * @ViewSetupProduct
         * @polymer 
         * @extends {Polymer.Element}
         * @appliesMixin Polymer.AppLocalizeBehavior
         */
        class ViewSetupProduct extends ReduxMixin(Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element)) {
            static get is() {
                return 'view-setup-product'
            }

            static get properties() {
                return {
                    language: String,
                    productData: {
                        type: Object,
                        notify: true
                    },
                    processData: Object,
                    toastText: String,
                    productKey: String,
                    editKey: String,
                    maxFiles: {
                        type: Number,
                        value: 1,
                        readOnly: true
                    },
                    maxFileSize: {
                        type: Number,
                        value: 1000000
                    },
                    maxProcess: {
                        type: Number,
                        value: 12,
                        readOnly: true
                    },
                    showListProduct: {
                        type: Boolean,
                        value: false
                    },

                    showAddProduct: {
                        type: Boolean,
                        value: true
                    },
                    showEditProduct: {
                        type: Boolean,
                        value: true
                    },

                    showAddPart: {
                        type: Boolean,
                        value: true
                    },
                    showEditPart: {
                        type: Boolean,
                        value: true
                    },
                    partProcess: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    partProcessCycle: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    partProcessSetup: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    productPart: {
                        type: Array,
                        notify: true,
                        value: () => {
                            return []
                        }
                    },
                    processDependency: {
                        type: Array,
                        value: () => {
                            return [{
                                "number": 0,
                                "required": "none"
                            }, {
                                "number": 1,
                                "required": "none"
                            }, {
                                "number": 2,
                                "required": "none"
                            }, {
                                "number": 3,
                                "required": "none"
                            }]

                        }
                    },
                    processBundle: {
                        type: Object,
                        notify: true
                    }
                }
            }

            static get observer() {
                return ['getPartBundle(partProcess, partProcessCycle, partProcessSetup)']
            }

            static get actions() {
                return {
                    add(data) {
                        return {
                            type: 'ADD_PART',
                            productPart: data
                        }
                    },
                    remove(data) {
                        return {
                            type: 'REMOVE_PART',
                            index: data
                        }
                    },
                    editCreate(data) {
                        return {
                            type: 'EDIT_SET_PART',
                            editPart: data
                        }
                    },
                    editAdd(data) {
                        return {
                            type: 'EDIT_ADD_PART',
                            editPart: data
                        }
                    },
                    editRemove(data) {
                        return {
                            type: 'EDIT_REMOVE_PART',
                            index: data
                        }
                    },
                    clear() {
                        return {
                            type: 'CLEAR_PART'
                        }
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback()
                this.loadResources(this.resolveUrl('../../data/locales.json'))
            }

            // Add Process to Part
            addProcessToPart() {
                if (this.selectedProcess && this.processCycle && this.processSetup) {
                    // if found duplicate it will return index > -1
                    let isDuplicated = this.partProcess.map(item => item).indexOf(this.selectedProcess) > -1
                    if (this.partProcess.length < this.maxProcess) {
                        if (isDuplicated) {
                            window.alert('You already added this process')
                            return
                        }
                        this.push('partProcess', this.selectedProcess)
                        this.push('partProcessCycle', parseInt(this.processCycle))
                        this.push('partProcessSetup', parseInt(this.processSetup))
                        this.getPartBundle(this.partProcess, this.partProcessCycle, this.partProcessSetup)
                        this.selectedProcess = null
                        this.processCycle = null
                        this.processSetup = null
                    } else {
                        windows.alert(`Can't add more than ${this.maxProcess} processes per station`)
                    }
                } else {
                    windows.alert('Please fill in process number, process cycle time and process setup time.')
                }
            }

            removeProcessFromPart(e) {
                let index = e.model.index;
                console.log("Selected index is " + e.model.index);
                console.log("Selected process is " + e.model.item);
                // console.log(this.partProcess.indexOf(e.model.item));
                this.splice('partProcess', index, 1);
                this.splice('partProcessCycle', index, 1);
                this.splice('partProcessSetup', index, 1);
                this.getPartBundle(this.partProcess, this.partProcessCycle, this.partProcessSetup)
            }

            // Add Part to Product
            addPartToProduct() {
                const partObj = {
                    name: this.partName,
                    sku: this.partSKU,
                    process: this.partProcess,
                    cycle: this.partProcessCycle,
                    setup: this.partProcessSetup
                };
                this.push('productPart', partObj)
                //  this._clearPartField();
                this.closeAddPartDialog();

            }

            removePartFromProduct(e) {
                let index = e.model.index;
                this.splice('productPart', index, 1)
            }

            clearPartFromProduct(e) {
                this.splice('productPart', 0, this.productPart.length)
            }

            // Add Product
            addProduct() {
                const productName = this.$.productName.value
                const productSKU = this.$.productSKU.value
                const processDependency = this.processDependency
                const timestamp = Math.round(Date.now() / 1000.0)
                const productColor = this.getRandomColor();
                let productPart = this.productPart
                let productCost = this.$.productCost.value
                let inventoryCode = this.$.inventoryCode.value
                let inventoryQuantity = this.$.inventoryQuantity.value
                let imageURL = "";
                if (!productCost) productCost = 0;
                if (!inventoryCode) inventoryCode = "none";
                if (!inventoryQuantity) inventoryQuantity = 0;
                productPart = productPart.splice(-1);
                console.log(productName)
                console.log(productSKU)
                console.log(productPart)
                if (productName && productSKU && productPart) {
                    if (this.imageURL) {
                        this._debouncer = Polymer.Debouncer.debounce(this._debouncer,
                            Polymer.Async.timeOut.after(3000), () => {
                                imageURL = this.imageURL;
                                this._addProduct(timestamp, productCost, productName, productSKU,
                                    inventoryCode, inventoryQuantity, productPart, productColor,
                                    imageURL)
                                this.toastText = 'Processing product.'
                                this.$.toastAlert.open()
                                this.openProductList()
                            });
                    } else {
                        imageURL =
                            "https://firebasestorage.googleapis.com/v0/b/smart-mes.appspot.com/o/default%2Fproduct%2Fstock-1.png?alt=media&token=6f83a0d2-5952-4e40-8a19-dbb51a8fbf37";
                        this._addProduct(timestamp, productCost, productName, productSKU, inventoryCode,
                            inventoryQuantity, productPart, productColor, imageURL)
                        this.openProductList()
                    }
                } else {
                    this.toastText = 'Please fill in the required field.'
                    this.$.toastAlert.open()
                }
            }

            _addProduct(timestamp, productCost, productName, productSKU, inventoryCode, inventoryQuantity,
                productPart, productColor, imageURL) {
                this.$.productQuery.ref.child(this.productKey).set({
                    add: timestamp,
                    cost: productCost,
                    name: productName,
                    sku: productSKU,
                    image: imageURL,
                    color: productColor,
                    inventory_code: inventoryCode,
                    inventory_use: inventoryQuantity,
                    part: productPart,
                    process: this.processDependency
                }).then(() => {
                    this.openProductList();
                    this.toastText = 'Add Product successfully.'
                    this.$.toastAlert.open()
                }).catch((error) => {
                    this.toastText = 'Add Product failed.'
                    this.$.toastAlert.open()
                    console.error(error)
                })
            }

            _updateProduct(timestamp, productCost, productName, productSKU, inventoryCode, inventoryQuantity,
                productPart, productColor, imageURL) {
                this.$.productQuery.ref.child(this.productKey).update({
                    add: timestamp,
                    cost: productCost,
                    name: productName,
                    sku: productSKU,
                    image: imageURL,
                    color: productColor,
                    inventory_code: inventoryCode,
                    inventory_use: inventoryQuantity,
                    part: productPart,
                    process: this.processDependency
                }).then(() => {
                    this.openProductList();
                    this.toastText = 'Add Product successfully.'
                    this.$.toastAlert.open()
                }).catch((error) => {
                    this.toastText = 'Add Product failed.'
                    this.$.toastAlert.open()
                    console.error(error)
                })
            }

            saveProduct() {
                const productName = this.$.productName.value
                const productSKU = this.$.productSKU.value
                const processDependency = this.processDependency
                const timestamp = Math.round(Date.now() / 1000.0)
                const productColor = this.getRandomColor();
                let productPart = this.productPart
                let productCost = this.$.productCost.value
                let inventoryCode = this.$.inventoryCode.value
                let inventoryQuantity = this.$.inventoryQuantity.value
                let imageURL = "";
                if (!productCost) productCost = 0;
                if (!inventoryCode) inventoryCode = "none";
                if (!inventoryQuantity) inventoryQuantity = 0;
                productPart = productPart.splice(-1);

                if (productName && productSKU && productPart && processDependency) {
                    if (this.imageURL) {
                        this._debouncer = Polymer.Debouncer.debounce(this._debouncer,
                            Polymer.Async.timeOut.after(3000), () => {
                                imageURL = this.imageURL;
                                this._updateProduct(timestamp, productCost, productName, productSKU,
                                    inventoryCode, inventoryQuantity, productPart, productColor,
                                    imageURL)
                                this.toastText = 'Processing product.'
                                this.$.toastAlert.open()
                            });
                        this.openProductList()
                    } else {
                        imageURL =
                            "https://firebasestorage.googleapis.com/v0/b/smart-mes.appspot.com/o/default%2Fproduct%2Fstock-1.png?alt=media&token=6f83a0d2-5952-4e40-8a19-dbb51a8fbf37";
                        this._updateProduct(timestamp, productCost, productName, productSKU, inventoryCode,
                            inventoryQuantity, productPart, productColor, imageURL)
                        this.openProductList()
                    }
                } else {
                    this.toastText = 'Please fill in the required field.'
                    this.$.toastAlert.open()
                }
            }

            removeProduct(e) {
                if (window.confirm("Delete this product ?") == true) {
                    const key = e.currentTarget.product.$key
                    this.$.productQuery.ref.child(key).remove()
                }
            }

            _verifyUploadFile() {
                let file = this.$.uploadImageFile.files[0]
                if (!file.type.match(/image.*/)) {
                    this.toastText = 'Invalid file format'
                    this.$.toastAlert.open()
                    this.$.uploadImageFile.value = null
                } else if (file.size > this.maxFileSize) {
                    this.toastText = 'File size maximum is 1 MB'
                    this.$.toastAlert.open()
                    this.$.uploadImageFile.value = null
                } else {
                    this.uploadProductImage(this.productKey)
                }
            }

            uploadProductImage(filename) {
                let file = this.$.uploadImageFile.files[0]

                if (file.type.match(/image.*/) && file.size < this.maxFileSize) {
                    this.toastText = 'Uploading image'
                    this.$.toastAlert.open()
                    let uid = this.user.uid
                    let storageRef = this.$.auth.app.storage().ref()
                    let metadata = {
                        'contentType': file.type
                    }
                    let imagesRef = storageRef.child('user/' + uid + '/product/' + filename)
                    imagesRef.put(file, metadata)
                        .then(snapshot => {
                            let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100
                            this.$.uploadProgress.value = progress
                            this.$.uploadImageFile.files.uploading = true
                            this.$.uploadImageFile.files.status = snapshot.state
                            this.$.uploadImageFile.files.progress = progress
                            this.$.uploadImageFile.files.loaded = snapshot.bytesTransferred
                            this.$.uploadImageFile.files.size = snapshot.totalBytes
                            let url = snapshot.metadata.downloadURLs[0]
                            if (url) {
                                this.imageURL = url;
                                this.$.uploadImageFile.files.complete = true
                                this.$.uploadImageFile.value = null
                            }
                        }).catch((error) => {
                            this.$.uploadImageFile.files.error = error
                            this.$.uploadImageFile.value = null
                            console.error('Upload failed:', error)
                        })
                } else {
                    this.toastText = 'Error: Invalid file format'
                    this.$.toastAlert.open()
                    this.$.uploadImageFile.value = null
                }
            }

            getRandomColor() {
                const color = Math.floor(0x1000000 * Math.random()).toString(16);
                return '#' + ('000000' + color).slice(-6);
            }

            openBrowseImageFile() {
                this.$.uploadImageFile.click()
            }

            openAddPartDialog() {
                this.$.addPartDialog.opened = true
            }

            closeAddPartDialog() {
                this.$.addPartDialog.opened = false
            }

            closeEditPartDialog() {
                this.$.editPartDialog.opened = false
            }

            openAddProductCard() {
                this.showAddProduct = false
                this.showListProduct = true
                this.productKey = this.$.productQuery.ref.push().key
            }

            openProductList() {
                this.showAddProduct = true
                this.showEditProduct = true
                this.showListProduct = false
            }

            openEditProductCard(e) {
                this.showEditProduct = false
                this.showListProduct = true
                let key = e.currentTarget.product.$key
                this.editKey = key
            }

            openEditPartDialog(e) {
                this.$.editPartDialog.opened = true
            }

            getPartBundle(processArr, cycleArr, setupArr) {
                if (!processArr || !cycleArr || !setupArr) return
                const processObj = processArr.map((s, index, arr) => ({
                    process: arr[index]
                }))
                const cycleObj = cycleArr.map((s, index, arr) => ({
                    cycle: arr[index]
                }))
                const setupObj = setupArr.map((s, index, arr) => ({
                    setup: arr[index]
                }))
                let mergeObj = []
                let i = 0
                while (i < processArr.length) {
                    mergeObj.push(Object.assign(processObj[i], cycleObj[i], setupObj[i]))
                    i++
                }
                this.processBundle = mergeObj;
                console.table(mergeObj)
                return mergeObj
            }

            getProductProcessSequence(arr) {
                if (!arr) return 'N/A'
                return arr.join('  ')
            }

            getProcessNumber(processNumber) {
                if (!processNumber) return 1
                return processNumber + 1
            }

            getSumSetupTime(setup) {
                if (!setup) return 0
                let sumSetupTime = setup.reduce((a, b) => a + b); // apply sum function to all arr items to get sumSetup
                return sumSetupTime.toFixed(1)
            }

            getSumCycleTime(cycle) {
                if (!cycle) return 0
                let sumCycleTime = cycle.reduce((a, b) => a + b) // apply sum function to all arr items to get sumCycle
                return sumCycleTime.toFixed(1)
            }

            _clearField() {
                this.$.productName.value = ""
                this.$.productSKU.value = ""
                this.$.inventoryCode.value = ""
                this.$.inventoryQuantity.value = ""
                this.$.uploadImageFile.value = ""
                this.editKey = ""
            }

            _clearPartField() {
                this.partName = ""
                this.partSKU = ""
            }
        }
        customElements.define(ViewSetupProduct.is, ViewSetupProduct)
    </script>
</dom-module>